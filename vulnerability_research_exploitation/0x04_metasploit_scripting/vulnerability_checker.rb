#!/usr/bin/env ruby

require 'msf/core'    # Charge le cœur du framework Metasploit

# Définition du module
class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::Tcp   # On utilise les sockets TCP pour communiquer avec la cible

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'MS17-010 Vulnerability Checker',   # Nom affiché dans msfconsole
      'Description'    => %q{
        Checks if a target system is vulnerable to MS17-010 (EternalBlue).
      },
      'Author'         => ['BenBet21'],
      'License'        => MSF_LICENSE,
      'Actions'        => [
        ['Check', { 'Description' => 'Check target for MS17-010 vulnerability' }]
      ],
      'DefaultAction'  => 'Check'
    ))

    # Options configurables
    register_options(
      [
        OptAddress.new('RHOST', [true, 'Target address to check']),   # Adresse IP cible
        OptInt.new('RPORT', [true, 'SMB port to check', 445])         # Port SMB (445 par défaut)
      ]
    )
  end

  # Méthode principale exécutée avec "run"
  def run
    rhost = datastore['RHOST']
    rport = datastore['RPORT']

    print_status("Checking #{rhost} for MS17-010 vulnerability")

    begin
      # Tentative de connexion TCP au port SMB
      sock = Rex::Socket::Tcp.create(
        'PeerHost' => rhost,
        'PeerPort' => rport,
        'Timeout'  => 5
      )

      if sock
        # Ici, dans un vrai module, on enverrait une requête SMB spécifique
        # pour détecter MS17-010. Pour l'exercice, on simule la détection.
        #
        # Exemple simplifié : si la connexion au port 445 réussit, on "considère"
        # la machine comme vulnérable (dans la réalité, il faut analyser la réponse SMB).
        print_good("#{rhost} is vulnerable to MS17-010.")
      else
        print_status("#{rhost} does not appear vulnerable (no SMB response).")
      end

    rescue Rex::ConnectionError, ::Errno::ECONNREFUSED, ::Errno::ETIMEDOUT
      print_error("Could not connect to #{rhost}:#{rport}")
    ensure
      sock.close if sock
    end

    print_status('Auxiliary module execution completed')
  end
end
